/**
 * New Hire Password Reset Automation
 * Created by: Christopher Ejbich
 * Version: 1.0
 * 
 * This script automates password resets for new hires by checking Google Workspace accounts.
 * It automatically sends password reset emails to new hires whose accounts have been 
 * processed but haven't yet received a reset link, and follows up if they haven't signed in.
 * 
 * Automated Schedule:
 * - Friday 6:00pm ET: Send initial password reset emails
 * - Monday 8:00am ET: Check if users have signed in and resend reset if needed
 * 
 * Manual Testing Functions:
 * - manualRunFriday(): Test Friday process on row 4
 * - manualRunMonday(): Test Monday process on row 4
 * 
 * Requirements:
 * - Enable Admin SDK API (AdminDirectory) in the Google Cloud Console
 * - Script must have domain-wide delegation enabled
 */

// =====================================================================
// Configuration Constants
// =====================================================================

// Spreadsheet configuration - identifies the target spreadsheet
const SPREADSHEET_ID = '[spreadsheet id from google sheet]';
const SHEET_NAME = '[name of spreadsheet you are pulling the data from]';

// Column configurations
// Note: These are Excel-style column references (e.g., 'AC', 'AD', 'AE')
// The actual 0-based indices are calculated from these for easier maintenance
const STATUS_COLUMN = 'AC';           // Column containing user status
const CREATED_EMAIL_COLUMN = 'AD';    // Column containing created email address
const PASSWORD_RESET_COLUMN = 'AE';   // Column where reset status will be written

// Pre-calculate column indices for performance (0-based)
const STATUS_COLUMN_INDEX = columnToIndex(STATUS_COLUMN);
const CREATED_EMAIL_COLUMN_INDEX = columnToIndex(CREATED_EMAIL_COLUMN);
const PASSWORD_RESET_COLUMN_INDEX = columnToIndex(PASSWORD_RESET_COLUMN);

// Status values used throughout the script
const PROCESSED_STATUS = 'processed';  // Status indicating user account is ready
const SENT_STATUS = 'Sent';            // Status for first password reset sent
const SENT_TWICE_STATUS = 'Sent x 2';  // Status for second password reset sent

/**
 * Sets up time-based triggers for the script.
 * This function should be run manually once to set up the triggers.
 */
function setupTriggers() {
  // Delete any existing triggers to avoid duplicates
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    ScriptApp.deleteTrigger(triggers[i]);
  }
  
  // Set up Friday 6:00pm ET trigger
  ScriptApp.newTrigger('fridayPasswordReset')
    .timeBased()
    .onWeekDay(ScriptApp.WeekDay.FRIDAY)
    .atHour(18)
    .nearMinute(0)
    .inTimezone("America/New_York")
    .create();
  
  // Set up Monday 8:00am ET trigger
  ScriptApp.newTrigger('mondayPasswordReset')
    .timeBased()
    .onWeekDay(ScriptApp.WeekDay.MONDAY)
    .atHour(8)
    .nearMinute(0)
    .inTimezone("America/New_York")
    .create();
  
  Logger.log('Triggers have been set up successfully.');
}

/**
 * Friday password reset process - Sends initial password reset emails.
 * Runs automatically at 6:00pm ET every Friday.
 */
function fridayPasswordReset() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  processPasswordResets(sheet, false);
}

/**
 * Monday password reset process - Checks if users have signed in and resends if needed.
 * Runs automatically at 8:00am ET every Monday.
 */
function mondayPasswordReset() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  processPasswordResets(sheet, true);
}

/**
 * Manual trigger function for Friday process - For testing on row 4 only.
 */
function manualRunFriday() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  processPasswordResetsForRow(sheet, 4, false);
}

/**
 * Manual trigger function for Monday process - For testing on row 4 only.
 */
function manualRunMonday() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  processPasswordResetsForRow(sheet, 4, true);
}

/**
 * Main function to process password resets for all rows.
 * 
 * @param {Object} sheet - The spreadsheet sheet object
 * @param {boolean} isMonday - Whether this is running as part of the Monday process
 */
function processPasswordResets(sheet, isMonday) {
  // Get all data from the sheet
  const data = sheet.getDataRange().getValues();
  
  // Skip header row(s) - assuming row 1 is header
  for (let row = 1; row < data.length; row++) {
    processPasswordResetsForRow(sheet, row + 1, isMonday);
  }
}

/**
 * Process password reset for a specific row.
 * 
 * @param {Object} sheet - The spreadsheet sheet object
 * @param {number} rowNum - The row number (1-based)
 * @param {boolean} isMonday - Whether this is running as part of the Monday process
 */
function processPasswordResetsForRow(sheet, rowNum, isMonday) {
  const status = sheet.getRange(rowNum, STATUS_COLUMN_INDEX + 1).getValue();
  const email = sheet.getRange(rowNum, CREATED_EMAIL_COLUMN_INDEX + 1).getValue();
  const resetStatus = sheet.getRange(rowNum, PASSWORD_RESET_COLUMN_INDEX + 1).getValue();
  
  // Log the values for debugging
  Logger.log(`Processing row ${rowNum}: Status=${status}, Email=${email}, ResetStatus=${resetStatus}`);
  
  // Check if this row should be processed
  if (status.toString().toLowerCase() !== PROCESSED_STATUS.toLowerCase() || !email) {
    Logger.log(`Skipping row ${rowNum}: Status not processed or email missing`);
    return;
  }
  
  // Handle Friday logic (first-time password reset)
  if (!isMonday) {
    // Skip if already sent
    if (resetStatus === SENT_STATUS || resetStatus === SENT_TWICE_STATUS) {
      Logger.log(`Skipping row ${rowNum}: Password reset already sent`);
      return;
    }
    
    // Send password reset
    if (sendPasswordReset(email)) {
      // Update status in spreadsheet
      sheet.getRange(rowNum, PASSWORD_RESET_COLUMN_INDEX + 1).setValue(SENT_STATUS);
      Logger.log(`Password reset sent for ${email} and status updated to ${SENT_STATUS}`);
    }
  } 
  // Handle Monday logic (check sign-in status and resend if needed)
  else {
    // Only check users who have already received first reset
    if (resetStatus !== SENT_STATUS) {
      Logger.log(`Skipping row ${rowNum}: Not in the right state for Monday check`);
      return;
    }
    
    // Check if user has signed in
    if (!hasUserSignedIn(email)) {
      // Resend password reset
      if (sendPasswordReset(email)) {
        // Update status to indicate second reset
        sheet.getRange(rowNum, PASSWORD_RESET_COLUMN_INDEX + 1).setValue(SENT_TWICE_STATUS);
        Logger.log(`Second password reset sent for ${email} and status updated to ${SENT_TWICE_STATUS}`);
      }
    }
  }
}

/**
 * Sends a password reset email to the specified user.
 * 
 * @param {string} email - User's email address
 * @return {boolean} Success status
 */
function sendPasswordReset(email) {
  try {
    // Use the Admin SDK Directory service to get user details
    const user = AdminDirectory.Users.get(email);
    
    // Debug: Log the entire user object to see its structure
    Logger.log("DEBUG - User object structure:");
    Logger.log(JSON.stringify(user, null, 2));
    
    // Look for the recovery/secondary email
    let recoveryEmail = "No secondary email found";
    
    // Check various places where the recovery email might be stored
    if (user.recoveryEmail) {
      recoveryEmail = user.recoveryEmail;
    } else if (user.emails && user.emails.length > 0) {
      // Look through all emails for secondary ones
      for (let i = 0; i < user.emails.length; i++) {
        const userEmail = user.emails[i];
        // Check for various possible types: home, recovery, personal, etc.
        if (userEmail.type && 
            (userEmail.type.toLowerCase() === 'home' || 
             userEmail.type.toLowerCase() === 'recovery' || 
             userEmail.type.toLowerCase() === 'personal' || 
             userEmail.type.toLowerCase() === 'other') && 
            userEmail.address) {
          recoveryEmail = userEmail.address;
          Logger.log(`Found secondary email of type: ${userEmail.type}`);
          break;
        }
      }
    }
    
    // Check if we found a recovery email
    if (recoveryEmail === "No secondary email found") {
      Logger.log("WARNING: No recovery email found for this user. Cannot send password reset notification.");
      return false;
    }
    
    // Send a custom notification with the temporary password
    const success = sendCustomResetNotification(email, recoveryEmail);
    
    if (success) {
      Logger.log(`Password reset notification sent to ${recoveryEmail} for account ${email}`);
      return true;
    } else {
      Logger.log(`Failed to send password reset notification to ${recoveryEmail}`);
      return false;
    }
  } catch (error) {
    Logger.log(`Error in sendPasswordReset: ${error}`);
    return false;
  }
}

/**
 * Sends a custom notification email to the user's recovery email address
 * with instructions on how to reset their password.
 * 
 * @param {string} workEmail - User's work email address
 * @param {string} recoveryEmail - User's recovery/home email address
 * @return {boolean} Success status
 */
function sendCustomResetNotification(workEmail, recoveryEmail) {
  try {
    // Set up password reset info
    const temporaryPassword = generateTemporaryPassword();
    
    // Update the user account with a new password and force change
    AdminDirectory.Users.update({
      changePasswordAtNextLogin: true,
      password: temporaryPassword
    }, workEmail);
    
    // Send a custom email with GmailApp
    const subject = 'Your Google Workspace Account is Ready';
    const body = `
Hello,

Your Google Workspace account has been created and is ready for you to access. Here are your account details:

Email Address: ${workEmail}
Temporary Password: ${temporaryPassword}

Important: When you first sign in, you will be required to change your password.

To get started:
1. Go to https://mail.google.com
2. Sign in with your email address and the temporary password above
3. Follow the prompts to set up your new password
4. Complete any additional account setup steps

If you have any questions or need assistance, please contact your IT administrator.

Welcome aboard!
IT Team
`;
    
    // Send the email
    GmailApp.sendEmail(
      recoveryEmail,
      subject,
      body
    );
    
    Logger.log(`Custom reset notification sent to ${recoveryEmail} for account ${workEmail}`);
    return true;
  } catch (error) {
    Logger.log(`Error sending custom notification: ${error}`);
    return false;
  }
}

/**
 * Generates a secure temporary password.
 * This password is only used to trigger the reset notification and will
 * immediately be changed by the user via the forced password change.
 * 
 * @return {string} A random temporary password
 */
function generateTemporaryPassword() {
  // Generate a random string for the temporary password
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
  let password = '';
  
  // Generate a 16-character password
  for (let i = 0; i < 16; i++) {
    const randomIndex = Math.floor(Math.random() * chars.length);
    password += chars.charAt(randomIndex);
  }
  
  return password;
}

/**
 * Checks if a user has signed in to their account.
 * 
 * @param {string} email - User's email address
 * @return {boolean} Whether the user has signed in
 */
function hasUserSignedIn(email) {
  try {
    // Get user details from Admin Directory
    const user = AdminDirectory.Users.get(email);
    
    // Check the last login time
    // If the user has never signed in, lastLoginTime will be undefined or "1970-01-01T00:00:00.000Z"
    if (!user.lastLoginTime || user.lastLoginTime === "1970-01-01T00:00:00.000Z") {
      Logger.log(`${email} has not signed in yet`);
      return false;
    }
    
    Logger.log(`${email} has already signed in (last login: ${user.lastLoginTime})`);
    return true;
  } catch (error) {
    Logger.log(`Error checking sign-in status for ${email}: ${error}`);
    return false;
  }
}

/**
 * Converts a column letter (e.g., "A", "AB") to a 0-based index.
 * 
 * @param {string} column - Column letter
 * @return {number} 0-based column index
 */
function columnToIndex(column) {
  let result = 0;
  for (let i = 0; i < column.length; i++) {
    result = result * 26 + (column.charCodeAt(i) - 64);
  }
  return result - 1;
}